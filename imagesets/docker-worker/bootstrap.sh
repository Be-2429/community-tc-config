#!/bin/bash

set -exv
exec &> /var/log/bootstrap.log

for CERT_FILE in /etc/star_taskcluster-worker_net.crt /etc/taskcluster/secrets/worker_livelog_tls_cert; do
  if [ -f "${CERT_FILE}" ]; then

    echo '-----BEGIN CERTIFICATE-----
MIIHDDCCBfSgAwIBAgIQC/OtXmozUAnZISekKR2SmjANBgkqhkiG9w0BAQsFADBZ
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMTMwMQYDVQQDEypE
aWdpQ2VydCBHbG9iYWwgRzIgVExTIFJTQSBTSEEyNTYgMjAyMCBDQTEwHhcNMjQw
NjE0MDAwMDAwWhcNMjUwNjE3MjM1OTU5WjB7MQswCQYDVQQGEwJVUzETMBEGA1UE
CBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZyYW5jaXNjbzEcMBoGA1UEChMT
TW96aWxsYSBDb3Jwb3JhdGlvbjEhMB8GA1UEAwwYKi50YXNrY2x1c3Rlci13b3Jr
ZXIubmV0MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA4ucNh32/dYp0
O3J559aRy6+QqYv1yxJcAZ63UlQCBpKQDZZraqGyyQy+MjhP3KmHkkNfrTozReSG
1Z6V0X8voLHKU9f2tVE5nDiX9v6XHT7xyEs9FTOZPQFNfLHnGAwjRbAhw14ROr2m
KHqETYqVF3HZbxxwX2mODSUwbs02mbQTWAhMZdUdkNTaFrSVsoCY9KQod3FfUc4j
vUJHhj/lgjtoyna8SbFMiHguoAz0c25QWRwi9FeejWd16mWj0ZudGKXbE5iTB2dC
ukiJgHwJ4yd7uRFL8fUNpi+zoXICDzhJrUHI/n8IRM2+pibCFhPaNTHcbq9jbzQz
Ylkb/GyDOwIDAQABo4IDrDCCA6gwHwYDVR0jBBgwFoAUdIWAwGbH3zfez70pN6oD
Hb7tzRcwHQYDVR0OBBYEFCVkgqudCRDFcOUkdC+5TdrmvMm4MDsGA1UdEQQ0MDKC
GCoudGFza2NsdXN0ZXItd29ya2VyLm5ldIIWdGFza2NsdXN0ZXItd29ya2VyLm5l
dDA+BgNVHSAENzA1MDMGBmeBDAECAjApMCcGCCsGAQUFBwIBFhtodHRwOi8vd3d3
LmRpZ2ljZXJ0LmNvbS9DUFMwDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsG
AQUFBwMBBggrBgEFBQcDAjCBnwYDVR0fBIGXMIGUMEigRqBEhkJodHRwOi8vY3Js
My5kaWdpY2VydC5jb20vRGlnaUNlcnRHbG9iYWxHMlRMU1JTQVNIQTI1NjIwMjBD
QTEtMS5jcmwwSKBGoESGQmh0dHA6Ly9jcmw0LmRpZ2ljZXJ0LmNvbS9EaWdpQ2Vy
dEdsb2JhbEcyVExTUlNBU0hBMjU2MjAyMENBMS0xLmNybDCBhwYIKwYBBQUHAQEE
ezB5MCQGCCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wUQYIKwYB
BQUHMAKGRWh0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEdsb2Jh
bEcyVExTUlNBU0hBMjU2MjAyMENBMS0xLmNydDAMBgNVHRMBAf8EAjAAMIIBfgYK
KwYBBAHWeQIEAgSCAW4EggFqAWgAdgDPEVbu1S58r/OHW9lpLpvpGnFnSrAX7KwB
0lt3zsw7CAAAAZAX+f44AAAEAwBHMEUCIQDlGUkqmVPO1Y/4X6W8fDmEkq5k425j
mK8R1LzkKmsaqQIgVlbjUIcsjRJzCJmeOLoHw5v/nB33x6GViu6BVXoddTYAdgB9
WR4S4XgqexxhZ3xe/fjQh1wUoE6VnrkDL9kOjC55uAAAAZAX+f40AAAEAwBHMEUC
IQCGdHPrNtqDwpJymyVJKOZ550ihODSNwsyM9uLlDd2+LAIgcPoalHZnMI9FHDBH
5f+2pMGbO3X6dGFmpoczp8+UdJcAdgDm0jFjQHeMwRBBBtdxuc7B0kD2loSG+7qH
Mh39HjeOUAAAAZAX+f5BAAAEAwBHMEUCIFEXTuo+qOHEQwUqs2H6jX+D8bBNqoii
czC+S+BC1HNtAiEA7IVpun92f15C2kkZnh4JT0ksQX2N6fCktRKbpqFUCFYwDQYJ
KoZIhvcNAQELBQADggEBAFiK9wK4N+ARNgy8/1qW8kZeV8ZGO3M1rhqONLqHjWeP
Ga+59CDbTAzuH1PDdPpfG1W0yxoMnJ12sWu+skp1a2be44AI5+V01j1DjWI0jLxT
hDplevtYpx0hWnxCTxCYq1xR1mP6fqwgFqOsOVwYCorgfamhL3vcG7xABIPcdgYd
JKpW0mV/bnFjLEBgVLucN0iXPAp+jhj7iHQWm5GCd5wND3oeLDXjBFcuMiowSHYn
SUSk7scNsKP/WdjDJv262zlHlyztBwFRxZbH7DiC9BgoBNxKMQW2KSBFKf6G7DhZ
Ow/cCEqHyP8nZ3ZhXtbU2PsNRV1aZQpanOpLPrHKuN4=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIEyDCCA7CgAwIBAgIQDPW9BitWAvR6uFAsI8zwZjANBgkqhkiG9w0BAQsFADBh
MQswCQYDVQQGEwJVUzEVMBMGA1UEChMMRGlnaUNlcnQgSW5jMRkwFwYDVQQLExB3
d3cuZGlnaWNlcnQuY29tMSAwHgYDVQQDExdEaWdpQ2VydCBHbG9iYWwgUm9vdCBH
MjAeFw0yMTAzMzAwMDAwMDBaFw0zMTAzMjkyMzU5NTlaMFkxCzAJBgNVBAYTAlVT
MRUwEwYDVQQKEwxEaWdpQ2VydCBJbmMxMzAxBgNVBAMTKkRpZ2lDZXJ0IEdsb2Jh
bCBHMiBUTFMgUlNBIFNIQTI1NiAyMDIwIENBMTCCASIwDQYJKoZIhvcNAQEBBQAD
ggEPADCCAQoCggEBAMz3EGJPprtjb+2QUlbFbSd7ehJWivH0+dbn4Y+9lavyYEEV
cNsSAPonCrVXOFt9slGTcZUOakGUWzUb+nv6u8W+JDD+Vu/E832X4xT1FE3LpxDy
FuqrIvAxIhFhaZAmunjZlx/jfWardUSVc8is/+9dCopZQ+GssjoP80j812s3wWPc
3kbW20X+fSP9kOhRBx5Ro1/tSUZUfyyIxfQTnJcVPAPooTncaQwywa8WV0yUR0J8
osicfebUTVSvQpmowQTCd5zWSOTOEeAqgJnwQ3DPP3Zr0UxJqyRewg2C/Uaoq2yT
zGJSQnWS+Jr6Xl6ysGHlHx+5fwmY6D36g39HaaECAwEAAaOCAYIwggF+MBIGA1Ud
EwEB/wQIMAYBAf8CAQAwHQYDVR0OBBYEFHSFgMBmx9833s+9KTeqAx2+7c0XMB8G
A1UdIwQYMBaAFE4iVCAYlebjbuYP+vq5Eu0GF485MA4GA1UdDwEB/wQEAwIBhjAd
BgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUHAwIwdgYIKwYBBQUHAQEEajBoMCQG
CCsGAQUFBzABhhhodHRwOi8vb2NzcC5kaWdpY2VydC5jb20wQAYIKwYBBQUHMAKG
NGh0dHA6Ly9jYWNlcnRzLmRpZ2ljZXJ0LmNvbS9EaWdpQ2VydEdsb2JhbFJvb3RH
Mi5jcnQwQgYDVR0fBDswOTA3oDWgM4YxaHR0cDovL2NybDMuZGlnaWNlcnQuY29t
L0RpZ2lDZXJ0R2xvYmFsUm9vdEcyLmNybDA9BgNVHSAENjA0MAsGCWCGSAGG/WwC
ATAHBgVngQwBATAIBgZngQwBAgEwCAYGZ4EMAQICMAgGBmeBDAECAzANBgkqhkiG
9w0BAQsFAAOCAQEAkPFwyyiXaZd8dP3A+iZ7U6utzWX9upwGnIrXWkOH7U1MVl+t
wcW1BSAuWdH/SvWgKtiwla3JLko716f2b4gp/DA/JIS7w7d7kwcsr4drdjPtAFVS
slme5LnQ89/nD/7d+MS5EHKBCQRfz5eeLjJ1js+aWNJXMX43AYGyZm0pGrFmCW3R
bpD0ufovARTFXFZkAdl9h6g4U5+LXUZtXMYnhIHUfoyMo5tS58aI7Dd8KvvwVVo4
chDYABPPTHPbqjc1qCmBaZx2vN4Ye5DUys/vZwP9BFohFrH/6j/f3IL16/RZkiMN
JCqVJUzKoZHm1Lesh3Sz8W2jmdv51b2EQJ8HmA==
-----END CERTIFICATE-----' | sudo tee "${CERT_FILE}"

  fi
done

# configure kvm vmware backdoor
# this enables a vmware compatible interface for kvm, and is needed for some fuzzing tasks
cat > /etc/modprobe.d/kvm-backdoor.conf << "EOF"
options kvm enable_vmware_backdoor=y
EOF

sudo shutdown -h now
